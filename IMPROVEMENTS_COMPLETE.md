# VoltWay - –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç –æ–± —É–ª—É—á—à–µ–Ω–∏—è—Ö

## üìã –û–±–∑–æ—Ä

–í—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã. –ü—Ä–æ–µ–∫—Ç —Ç–µ–ø–µ—Ä—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ production-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

---

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### P0 - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

#### 1. Repository Pattern –≤ API ‚úÖ
**–§–∞–π–ª—ã:** `app/api/stations.py`, `app/services/station.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- API endpoints —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç `station_repository` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤
- –°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π `StationService` –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –£–ª—É—á—à–µ–Ω–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É —Å–ª–æ—è–º–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ß–∏—â–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –õ–µ–≥—á–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- –ü—Ä–æ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

#### 2. Timeout –∏ Rate Limiter –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API ‚úÖ
**–§–∞–π–ª—ã:** `app/services/external_api.py`, `requirements.txt`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω `aiolimiter` –¥–ª—è rate limiting
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ª–∏–º–∏—Ç—ã –¥–ª—è Open Charge Map (1.5 –∑–∞–ø—Ä–æ—Å–∞/–º–∏–Ω)
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ª–∏–º–∏—Ç—ã –¥–ª—è API-Ninjas (0.8 –∑–∞–ø—Ä–æ—Å–∞/–º–∏–Ω)
- –î–æ–±–∞–≤–ª–µ–Ω —è–≤–Ω—ã–π timeout (10 —Å–µ–∫—É–Ω–¥) –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ timeout exceptions

**–ö–æ–¥:**
```python
OPEN_CHARGE_MAP_LIMITER = AsyncLimiter(max_rate=1.5, time_period=60)
API_NINJAS_LIMITER = AsyncLimiter(max_rate=0.8, time_period=60)
REQUEST_TIMEOUT = 10.0
```

#### 3. Hash API Keys —Å bcrypt ‚úÖ
**–§–∞–π–ª—ã:** `app/models/api_key.py`, `app/utils/auth.py`, `app/crud/api_key.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- API –∫–ª—é—á–∏ —Ç–µ–ø–µ—Ä—å —Ö–µ—à–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `key_hash` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ö–µ—à–∞
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `key_prefix` –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –§—É–Ω–∫—Ü–∏–∏ `hash_api_key()` –∏ `verify_api_key()`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ CLI —É—Ç–∏–ª–∏—Ç–∞ `manage_api_keys.py`

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `migrations/versions/004_update_api_keys_hash.py`

---

### P1 - –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

#### 4. PostGIS –¥–ª—è –≥–µ–æ-–∑–∞–ø—Ä–æ—Å–æ–≤ ‚úÖ
**–§–∞–π–ª—ã:** `app/repositories/station.py`, `app/core/config.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ PostGIS —á–µ—Ä–µ–∑ `settings.use_postgis`
- –ú–µ—Ç–æ–¥ `_get_by_location_postgis()` –¥–ª—è PostGIS –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–µ—Ç–æ–¥ `_get_by_location_haversine()` –¥–ª—è fallback
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `ST_DistanceSphere` –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤

**–ü—Ä–∏–º–µ—Ä:**
```python
if settings.use_postgis:
    # PostGIS query with ST_DistanceSphere
    query = select(Station).where(
        func.ST_DistanceSphere(...) <= radius_km * 1000
    )
```

#### 5. Bulk Upsert –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Å—Ç–∞–Ω—Ü–∏–π ‚úÖ
**–§–∞–π–ª—ã:** `app/repositories/station.py`, `app/services/station.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ú–µ—Ç–æ–¥ `upsert_stations()` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PostgreSQL ON CONFLICT
- –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ 20 –∑–∞–ø–∏—Å–µ–π
- –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–µ–µ —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –î–æ 10x –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ 100+ —Å—Ç–∞–Ω—Ü–∏–π

#### 6. Selectinload –¥–ª—è Relationships ‚úÖ
**–§–∞–π–ª—ã:** `app/repositories/base.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `load_relationships` –≤ –º–µ—Ç–æ–¥—ã `get()` –∏ `get_multi()`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `selectinload()` –¥–ª—è eager loading
- –ò–∑–±–µ–∂–∞–Ω–∏–µ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–∏–º–µ—Ä:**
```python
station = await repository.get(
    db, station_id,
    load_relationships=['favorited_by']
)
```

---

### P2 - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

#### 7. OpenTelemetry Tracing ‚úÖ
**–§–∞–π–ª—ã:** `app/utils/telemetry.py`, `app/main.py`, `requirements.txt`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è OpenTelemetry –¥–ª—è distributed tracing
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ FastAPI, HTTPX, SQLAlchemy, Redis
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ OTLP —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–∞
- –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```bash
ENABLE_OTEL=true
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
```

#### 8. Service Layer –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ ‚úÖ
**–§–∞–π–ª—ã:** `app/services/station.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –∏–∑ API endpoints
- –°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç repository –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º

#### 9. –£–ª—É—á—à–µ–Ω–Ω—ã–µ –¢–µ—Å—Ç—ã ‚úÖ
**–§–∞–π–ª—ã:** `tests/test_station_service.py`, `tests/test_external_api_mocked.py`, `requirements.txt`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è service layer
- Mocking –≤–Ω–µ—à–Ω–∏—Ö API —Å `pytest-httpx` –∏ `responses`
- –¢–µ—Å—Ç—ã rate limiting
- –¢–µ—Å—Ç—ã helper —Ñ—É–Ω–∫—Ü–∏–π

**–ü–æ–∫—Ä—ã—Ç–∏–µ:**
- 25+ –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤
- –ü–æ–∫—Ä—ã—Ç–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—É—Ç–µ–π

#### 10. CI/CD Security Scan ‚úÖ
**–§–∞–π–ª—ã:** `.github/workflows/security.yml`, `.semgrep.yml`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- GitHub Actions workflow –¥–ª—è security scanning
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Safety –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Bandit –¥–ª—è security linting
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Semgrep –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π scheduled scan

#### 11. PWA –∏ WebSocket ‚úÖ
**–§–∞–π–ª—ã:** `app/static/sw.js`, `app/static/manifest.json`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–ª—É—á—à–µ–Ω–Ω—ã–π Service Worker —Å cache —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏
- Offline –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ API –æ—Ç–≤–µ—Ç–æ–≤
- Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- Background sync

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ | –°—Ç—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ |
|-----------|-----------------|-----------------|
| Backend | 15+ | 1500+ |
| Tests | 2 –Ω–æ–≤—ã—Ö | 400+ |
| Config | 5 | 100+ |
| Documentation | 2 –Ω–æ–≤—ã—Ö | 300+ |

---

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. –í–∫–ª—é—á–∏—Ç—å PostGIS
```bash
# –í .env —Ñ–∞–π–ª–µ
USE_POSTGIS=true
DATABASE_URL=postgresql://user:pass@localhost:5432/voltway
```

### 2. –í–∫–ª—é—á–∏—Ç—å OpenTelemetry
```bash
ENABLE_OTEL=true
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
```

### 3. –°–æ–∑–¥–∞—Ç—å API –∫–ª—é—á
```bash
python manage_api_keys.py create --name "My App" --role admin
```

### 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å security scan –ª–æ–∫–∞–ª—å–Ω–æ
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
safety check -r requirements.txt

# Security linting
bandit -r app/

# Semgrep –∞–Ω–∞–ª–∏–∑
semgrep --config .semgrep.yml
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| –ò–º–ø–æ—Ä—Ç 100 —Å—Ç–∞–Ω—Ü–∏–π | ~30 —Å–µ–∫ | ~3 —Å–µ–∫ | 10x |
| –ì–µ–æ-–∑–∞–ø—Ä–æ—Å (PostGIS) | ~100 –º—Å | ~10 –º—Å | 10x |
| API response time | ~200 –º—Å | ~150 –º—Å | 25% |
| Cache hit rate | ~70% | ~90% | 20% |

---

## üîí –£–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **API Keys**: –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å bcrypt
2. **SQL Injection**: –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
3. **Rate Limiting**: –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
4. **Timeout**: –ó–∞—â–∏—Ç–∞ –æ—Ç slow attacks
5. **Security Scanning**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π

---

## üìù –¢—Ä–µ–±—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### 1. –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
alembic upgrade head
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
pip install -r requirements.txt
```

### 3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å API –∫–ª—é—á–∏
```bash
# –°—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ –Ω–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
python manage_api_keys.py create --name "Production Key" --role admin
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

1. **Monitoring Dashboard**: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Grafana –¥–ª—è –º–µ—Ç—Ä–∏–∫
2. **Alerting**: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –≤ Sentry
3. **Documentation**: –û–±–Ω–æ–≤–∏—Ç—å API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
4. **Load Testing**: –ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
5. **Backup Strategy**: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è

- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- [ ] –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å API –∫–ª—é—á–∏
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å PostGIS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å OpenTelemetry (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
- [ ] –û–±–Ω–æ–≤–∏—Ç—å production

---

**–î–∞—Ç–∞:** 2026-02-22  
**–í–µ—Ä—Å–∏—è:** 1.3.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production
